rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆæœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ã‚‚OKï¼‰
    match /furestorenews/{newsId} {
      allow read: if true;  // èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯
      allow write: if false;  // æ›¸ãè¾¼ã¿ã¯ç®¡ç†è€…ã®ã¿ï¼ˆConsoleã‹ã‚‰ï¼‰
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆTrigger Email Extensionç”¨ï¼‰
    match /mail/{mailId} {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã¯æœªèªè¨¼ã§ã‚‚é€ä¿¡å¯èƒ½
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 1ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ãŸã‚Š1æ—¥5é€šã¾ã§
      allow create: if request.resource.data.to is list &&
                       request.resource.data.to.size() > 0 &&
                       request.resource.data.to[0] is string;
      allow read, update, delete: if false;  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ç¦æ­¢
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    match /mail_rate_limit/{email} {
      allow read: if true;
      allow write: if false;  // ã‚¢ãƒ—ãƒªã‹ã‚‰ã¯æ›¸ãè¾¼ã¿ä¸å¯ï¼ˆExtensionãŒç®¡ç†ï¼‰
    }

    // é€šçŸ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ç”¨
    match /notifications/{notificationId} {
      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null &&
                     resource.data.userId == request.auth.uid;

      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šçŸ¥ã‚’ä½œæˆå¯èƒ½
      allow create: if request.auth != null;

      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null &&
                               resource.data.userId == request.auth.uid;
    }

    // æ‹›å¾…ãƒ­ã‚°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šæ‹›å¾…å—è«¾ã®è¨˜éŒ²ç”¨
    match /invitation_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;  // è¨˜éŒ²ã¯å¤‰æ›´ä¸å¯
    }

    // æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ç®¡ç†
    // SharedGroups/{groupId}/invitations/{invitationId}
    // ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨© = æ‹›å¾…ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ï¼ˆè‡ªå‹•ç¶™æ‰¿ï¼‰

    // ğŸ”’ æœ¬ç•ªç’°å¢ƒç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆåŸºæœ¬æƒ…å ±ï¼‰
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼šè‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿èª­ã¿æ›¸ãå¯èƒ½
      match /profile/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // å—è«¾æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚æ›¸ãè¾¼ã¿å¯èƒ½ï¼ˆæ‹›å¾…å—è«¾ç”¨ï¼‰
      match /acceptedInvitations/{acceptorUid} {
        // ğŸ“ é‡è¦: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚ä½œæˆå¯èƒ½ï¼ˆæ‹›å¾…å—è«¾è¨˜éŒ²ç”¨ï¼‰
        allow create: if request.auth != null &&
                         request.auth.uid == acceptorUid &&
                         request.resource.data.acceptorUid == acceptorUid;

        // èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯æ‹›å¾…å…ƒï¼ˆè¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã®ã¿
        allow read, update, delete: if request.auth != null &&
                                       request.auth.uid == userId;
      }
    }

    // SharedGroupï¼šallowedUidsãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /SharedGroups/{groupId} {
      // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
      function isGroupMember() {
        return request.auth != null && (
          resource.data.ownerUid == request.auth.uid ||
          request.auth.uid in resource.data.allowedUid
        );
      }

      // èª­ã¿å–ã‚Š: allowedUidã«å«ã¾ã‚Œã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿
      allow read: if request.auth != null &&
                     request.auth.uid in resource.data.allowedUid;

      // ä½œæˆ: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã‚’ownerã«ã—ã€allowedUidã«è‡ªåˆ†ã‚’å«ã‚ã‚‹
      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid &&
        request.auth.uid in request.resource.data.allowedUid;

      // æ›´æ–°: allowedUidãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
      allow update: if isGroupMember();

      // å‰Šé™¤: æ‰€æœ‰è€…ã®ã¿
      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;

      // æ‹›å¾…ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãŒç®¡ç†å¯èƒ½
      match /invitations/{invitationId} {
        // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã¯è¦ªã‚°ãƒ«ãƒ¼ãƒ—ã®readæ¨©é™ã§åˆ¶å¾¡ï¼‰
        allow read: if request.auth != null;

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰æ‹›å¾…ã‚’ä½œæˆå¯èƒ½
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // æ‹›å¾…ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®æ›´æ–°ï¼ˆcurrentUses, usedByé…åˆ—ã¸ã®è¿½åŠ ï¼‰
        allow update: if request.auth != null &&
          resource.data.status == 'pending' &&
          request.resource.data.currentUses == resource.data.currentUses + 1 &&
          request.auth.uid in request.resource.data.usedBy;

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰æ‹›å¾…ã‚’å‰Šé™¤å¯èƒ½
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );
      }

      // ãƒªã‚¹ãƒˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      match /shoppingLists/{listId} {
        // è¦ªã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ç¢ºèªç”¨é–¢æ•°
        function isGroupMember() {
          let group = get(/databases/$(database)/documents/SharedGroups/$(groupId)).data;
          return request.auth != null && (
            group.ownerUid == request.auth.uid ||
            request.auth.uid in group.allowedUid
          );
        }

        // èª­ã¿å–ã‚Šãƒ»ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤: ã™ã¹ã¦ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰è¨±å¯
        allow read, create, update, delete: if isGroupMember();
      }
    }
  }
}
