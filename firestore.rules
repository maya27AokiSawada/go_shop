rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ニュースコレクション：誰でも読み取り可能（未サインインでもOK）
    match /furestorenews/{newsId} {
      allow read: if true;  // 誰でも読み取り可
      allow write: if false;  // 書き込みは管理者のみ（Consoleから）
    }

    // メール送信コレクション（Trigger Email Extension用）
    match /mail/{mailId} {
      // パスワードリセットメールは未認証でも送信可能
      // レート制限: 1メールアドレスあたり1日5通まで
      allow create: if request.resource.data.to is list &&
                       request.resource.data.to.size() > 0 &&
                       request.resource.data.to[0] is string;
      allow read, update, delete: if false;  // セキュリティのため禁止
    }

    // メール送信レート制限用カウンター
    match /mail_rate_limit/{email} {
      allow read: if true;
      allow write: if false;  // アプリからは書き込み不可（Extensionが管理）
    }

    // 通知コレクション：リアルタイム通知用
    match /notifications/{notificationId} {
      // 自分宛の通知のみ読み取り可能
      allow read: if request.auth != null &&
                     resource.data.userId == request.auth.uid;

      // 認証済みユーザーは通知を作成可能
      allow create: if request.auth != null;

      // 自分宛の通知のみ更新・削除可能
      allow update, delete: if request.auth != null &&
                               resource.data.userId == request.auth.uid;
    }

    // 招待コレクション（トップレベル）：QR招待システム用
    match /invitations/{invitationId} {
      // 認証済みユーザーは招待の読み取り・作成・更新が可能
      allow read, create, update: if request.auth != null;

      // 削除は招待作成者のみ可能
      allow delete: if request.auth != null &&
                       resource.data.invitedBy == request.auth.uid;
    }

    // 招待ログコレクション：招待受諾の記録用
    match /invitation_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;  // 記録は変更不可
    }

    // ユーザードキュメント（基本情報）
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ユーザープロファイル：自分のプロファイルのみ読み書き可能
      match /profile/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // 受諾招待コレクション：誰でも書き込み可能（招待受諾用）
      match /acceptedInvitations/{acceptorUid} {
        allow create: if request.auth != null &&
                         request.auth.uid == acceptorUid &&
                         request.resource.data.acceptorUid == acceptorUid;

        allow read, update, delete: if request.auth != null &&
                                       request.auth.uid == userId;
      }
    }

    // SharedGroup：allowedUidsベースのアクセス制御
    match /SharedGroups/{groupId} {
      function isGroupMember() {
        return request.auth != null && (
          resource.data.ownerUid == request.auth.uid ||
          request.auth.uid in resource.data.allowedUid
        );
      }

      function isGroupMemberForWrite() {
        // 書き込み時はrequest.resource.dataを使用（新規作成時対応）
        return request.auth != null && (
          request.resource.data.ownerUid == request.auth.uid ||
          request.auth.uid in request.resource.data.allowedUid
        );
      }

      // 読み取り権限を get と list に分離
      allow get: if request.auth != null;
      allow list: if request.auth != null && request.auth.uid in resource.data.allowedUid;

      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid &&
        request.auth.uid in request.resource.data.allowedUid;

      allow update: if isGroupMember();

      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;

      // invitations サブコレクション
      match /invitations/{invitationId} {
        // 読み取り：認証済みユーザー全員（招待を受け取る人はまだメンバーではない）
        allow read: if request.auth != null;

        // 作成・更新：グループメンバーのみ（招待を作成する人）
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // 削除：招待作成者または グループオーナーのみ
        allow delete: if request.auth != null && (
          resource.data.invitedBy == request.auth.uid ||
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid
        );
      }

      // sharedLists サブコレクション（修正版）
      match /sharedLists/{listId} {
        // 読み取り：グループメンバーのみ
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // 作成・更新：グループメンバーのみ
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // 削除：グループメンバーのみ
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );
      }
    }

    // コレクショングループクエリ用ルール (`collectionGroup('sharedLists')`)
    match /{path=**}/sharedLists/{listId} {
      function isListOwnerOrMember() {
        let group = get(/databases/$(database)/documents/SharedGroups/$(resource.data.groupId));
        return request.auth != null && (
          group.data.ownerUid == request.auth.uid ||
          request.auth.uid in group.data.allowedUid
        );
      }

      allow read: if isListOwnerOrMember();
      allow create, update, delete: if false; // 直接の書き込みは禁止
    }
  }
}
