rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆæœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ã‚‚OKï¼‰
    match /furestorenews/{newsId} {
      allow read: if true;  // èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯
      allow write: if false;  // æ›¸ãè¾¼ã¿ã¯ç®¡ç†è€…ã®ã¿ï¼ˆConsoleã‹ã‚‰ï¼‰
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆTrigger Email Extensionç”¨ï¼‰
    match /mail/{mailId} {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã¯æœªèªè¨¼ã§ã‚‚é€ä¿¡å¯èƒ½
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 1ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ãŸã‚Š1æ—¥5é€šã¾ã§
      allow create: if request.resource.data.to is list &&
                       request.resource.data.to.size() > 0 &&
                       request.resource.data.to[0] is string;
      allow read, update, delete: if false;  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ç¦æ­¢
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    match /mail_rate_limit/{email} {
      allow read: if true;
      allow write: if false;  // ã‚¢ãƒ—ãƒªã‹ã‚‰ã¯æ›¸ãè¾¼ã¿ä¸å¯ï¼ˆExtensionãŒç®¡ç†ï¼‰
    }

    // é€šçŸ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ç”¨
    match /notifications/{notificationId} {
      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null &&
                     resource.data.userId == request.auth.uid;

      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šçŸ¥ã‚’ä½œæˆå¯èƒ½
      allow create: if request.auth != null;

      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null &&
                               resource.data.userId == request.auth.uid;
    }

    // æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰ï¼šQRæ‹›å¾…ã‚·ã‚¹ãƒ†ãƒ ç”¨
    match /invitations/{invitationId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ‹›å¾…ã®èª­ã¿å–ã‚Šãƒ»ä½œæˆãƒ»æ›´æ–°ãŒå¯èƒ½
      allow read, create, update: if request.auth != null;

      // å‰Šé™¤ã¯æ‹›å¾…ä½œæˆè€…ã®ã¿å¯èƒ½
      allow delete: if request.auth != null &&
                       resource.data.invitedBy == request.auth.uid;
    }

    // æ‹›å¾…ãƒ­ã‚°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šæ‹›å¾…å—è«¾ã®è¨˜éŒ²ç”¨
    match /invitation_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;  // è¨˜éŒ²ã¯å¤‰æ›´ä¸å¯
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆdisplayName, email, createdAt, updatedAtï¼‰
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // å—è«¾æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚æ›¸ãè¾¼ã¿å¯èƒ½ï¼ˆæ‹›å¾…å—è«¾ç”¨ï¼‰
      match /acceptedInvitations/{acceptorUid} {
        allow create: if request.auth != null &&
                         request.auth.uid == acceptorUid &&
                         request.resource.data.acceptorUid == acceptorUid;

        allow read, update, delete: if request.auth != null &&
                                       request.auth.uid == userId;
      }
    }

    // SharedGroupï¼šallowedUidsãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /SharedGroups/{groupId} {
      function isGroupMember() {
        return request.auth != null && (
          resource.data.ownerUid == request.auth.uid ||
          request.auth.uid in resource.data.allowedUid
        );
      }

      function isGroupMemberForWrite() {
        // æ›¸ãè¾¼ã¿æ™‚ã¯request.resource.dataã‚’ä½¿ç”¨ï¼ˆæ–°è¦ä½œæˆæ™‚å¯¾å¿œï¼‰
        return request.auth != null && (
          request.resource.data.ownerUid == request.auth.uid ||
          request.auth.uid in request.resource.data.allowedUid
        );
      }

      // èª­ã¿å–ã‚Šæ¨©é™ã‚’ get ã¨ list ã«åˆ†é›¢
      allow get: if request.auth != null;
      allow list: if request.auth != null && request.auth.uid in resource.data.allowedUid;

      // ğŸ”¥ TEMPORARY: ãƒ†ã‚¹ãƒˆç”¨ã«ç·©å’Œï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯æˆ»ã™ã“ã¨ï¼‰
      allow create: if request.auth != null;
      // allow create: if request.auth != null &&
      //   request.resource.data.ownerUid == request.auth.uid &&
      //   request.auth.uid in request.resource.data.allowedUid;

      allow update: if isGroupMember();

      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;

      // invitations ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      match /invitations/{invitationId} {
        // èª­ã¿å–ã‚Šï¼šèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨å“¡ï¼ˆæ‹›å¾…ã‚’å—ã‘å–ã‚‹äººã¯ã¾ã ãƒ¡ãƒ³ãƒãƒ¼ã§ã¯ãªã„ï¼‰
        allow read: if request.auth != null;

        // ä½œæˆãƒ»æ›´æ–°ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ï¼ˆæ‹›å¾…ã‚’ä½œæˆã™ã‚‹äººï¼‰
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // å‰Šé™¤ï¼šæ‹›å¾…ä½œæˆè€…ã¾ãŸã¯ ã‚°ãƒ«ãƒ¼ãƒ—ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿
        allow delete: if request.auth != null && (
          resource.data.invitedBy == request.auth.uid ||
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid
        );
      }

      // sharedLists ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¿®æ­£ç‰ˆï¼‰
      match /sharedLists/{listId} {
        // èª­ã¿å–ã‚Šï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // ä½œæˆãƒ»æ›´æ–°ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
        allow create, update: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );

        // å‰Šé™¤ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
        );
      }
    }

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‚¯ã‚¨ãƒªç”¨ãƒ«ãƒ¼ãƒ« (`collectionGroup('sharedLists')`)
    match /{path=**}/sharedLists/{listId} {
      function isListOwnerOrMember() {
        let group = get(/databases/$(database)/documents/SharedGroups/$(resource.data.groupId));
        return request.auth != null && (
          group.data.ownerUid == request.auth.uid ||
          request.auth.uid in group.data.allowedUid
        );
      }

      allow read: if isListOwnerOrMember();
      allow create, update, delete: if false; // ç›´æ¥ã®æ›¸ãè¾¼ã¿ã¯ç¦æ­¢
    }
  }
}
