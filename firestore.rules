rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆæœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ã‚‚OKï¼‰
    match /furestorenews/{newsId} {
      allow read: if true;  // èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯
      allow write: if false;  // æ›¸ãè¾¼ã¿ã¯ç®¡ç†è€…ã®ã¿ï¼ˆConsoleã‹ã‚‰ï¼‰
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆTrigger Email Extensionç”¨ï¼‰
    match /mail/{mailId} {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã¯æœªèªè¨¼ã§ã‚‚é€ä¿¡å¯èƒ½
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 1ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ãŸã‚Š1æ—¥5é€šã¾ã§
      allow create: if request.resource.data.to is list &&
                       request.resource.data.to.size() > 0 &&
                       request.resource.data.to[0] is string;
      allow read, update, delete: if false;  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ç¦æ­¢
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    match /mail_rate_limit/{email} {
      allow read: if true;
      allow write: if false;  // ã‚¢ãƒ—ãƒªã‹ã‚‰ã¯æ›¸ãè¾¼ã¿ä¸å¯ï¼ˆExtensionãŒç®¡ç†ï¼‰
    }

    // é€šçŸ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ç”¨
    match /notifications/{notificationId} {
      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null &&
                     resource.data.userId == request.auth.uid;

      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šçŸ¥ã‚’ä½œæˆå¯èƒ½
      allow create: if request.auth != null;

      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null &&
                               resource.data.userId == request.auth.uid;
    }

    // æ‹›å¾…ãƒ­ã‚°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šæ‹›å¾…å—è«¾ã®è¨˜éŒ²ç”¨
    match /invitation_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;  // è¨˜éŒ²ã¯å¤‰æ›´ä¸å¯
    }

    // æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ç®¡ç†
    // purchaseGroups/{groupId}/invitations/{invitationId}
    // ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨© = æ‹›å¾…ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ï¼ˆè‡ªå‹•ç¶™æ‰¿ï¼‰

    // ğŸ”’ æœ¬ç•ªç’°å¢ƒç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆåŸºæœ¬æƒ…å ±ï¼‰
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // å—è«¾æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚æ›¸ãè¾¼ã¿å¯èƒ½ï¼ˆæ‹›å¾…å—è«¾ç”¨ï¼‰
      match /acceptedInvitations/{acceptorUid} {
        // ğŸ“ é‡è¦: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚ä½œæˆå¯èƒ½ï¼ˆæ‹›å¾…å—è«¾è¨˜éŒ²ç”¨ï¼‰
        allow create: if request.auth != null &&
                         request.auth.uid == acceptorUid &&
                         request.resource.data.acceptorUid == acceptorUid;

        // èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯æ‹›å¾…å…ƒï¼ˆè¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã®ã¿
        allow read, update, delete: if request.auth != null &&
                                       request.auth.uid == userId;
      }
    }

    // PurchaseGroupï¼šallowedUidsãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /purchaseGroups/{groupId} {
      // èª­ã¿å–ã‚Š: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰è¨±å¯ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸åœ¨ã§ã‚‚404ã‚’è¿”ã›ã‚‹ã‚ˆã†ã«ï¼‰
      // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå­˜åœ¨æ™‚ã®ã¿æ‰€æœ‰è€…ãƒ»ãƒ¡ãƒ³ãƒãƒ¼ãƒã‚§ãƒƒã‚¯
      allow read: if request.auth != null;

      // ä½œæˆ: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã‚’ownerã«ã™ã‚‹å ´åˆã®ã¿
      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid;

      // æ›´æ–°: æ‰€æœ‰è€…ã®ã¿
      allow update: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;

      // å‰Šé™¤: æ‰€æœ‰è€…ã®ã¿
      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;

      // æ‹›å¾…ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãŒç®¡ç†å¯èƒ½
      match /invitations/{invitationId} {
        // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã¯è¦ªã‚°ãƒ«ãƒ¼ãƒ—ã®readæ¨©é™ã§åˆ¶å¾¡ï¼‰
        allow read: if request.auth != null;

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰æ‹›å¾…ã‚’ä½œæˆå¯èƒ½
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/purchaseGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/purchaseGroups/$(groupId)).data.allowedUid
        );

        // æ‹›å¾…ã‚’ä½¿ç”¨ã™ã‚‹éš›ã®æ›´æ–°ï¼ˆcurrentUses, usedByé…åˆ—ã¸ã®è¿½åŠ ï¼‰
        allow update: if request.auth != null &&
          resource.data.status == 'pending' &&
          request.resource.data.currentUses == resource.data.currentUses + 1 &&
          request.auth.uid in request.resource.data.usedBy;

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ãªã‚‰æ‹›å¾…ã‚’å‰Šé™¤å¯èƒ½
        allow delete: if request.auth != null && (
          get(/databases/$(database)/documents/purchaseGroups/$(groupId)).data.ownerUid == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/purchaseGroups/$(groupId)).data.allowedUid
        );
      }
    }

    // ShoppingListï¼šallowedUidsãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /shoppingLists/{listId} {
      allow read, write: if request.auth != null && (
        resource.data.ownerUid == request.auth.uid ||
        request.auth.uid in resource.data.allowedUids
      );

      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid;

      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;
    }
  }
}
