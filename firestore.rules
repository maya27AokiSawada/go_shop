rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆæœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ã‚‚OKï¼‰
    match /furestorenews/{newsId} {
      allow read: if true;  // èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯
      allow write: if false;  // æ›¸ãè¾¼ã¿ã¯ç®¡ç†è€…ã®ã¿ï¼ˆConsoleã‹ã‚‰ï¼‰
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆTrigger Email Extensionç”¨ï¼‰
    match /mail/{mailId} {
      allow create: if request.auth != null;  // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ä½œæˆå¯èƒ½
      allow read, update, delete: if false;  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ç¦æ­¢
    }

    // é€šçŸ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ç”¨
    match /notifications/{notificationId} {
      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null &&
                     resource.data.userId == request.auth.uid;

      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šçŸ¥ã‚’ä½œæˆå¯èƒ½
      allow create: if request.auth != null;

      // è‡ªåˆ†å®›ã®é€šçŸ¥ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null &&
                               resource.data.userId == request.auth.uid;
    }

    // æ‹›å¾…ãƒ­ã‚°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šæ‹›å¾…å—è«¾ã®è¨˜éŒ²ç”¨
    match /invitation_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;  // è¨˜éŒ²ã¯å¤‰æ›´ä¸å¯
    }

    // é–‹ç™ºç’°å¢ƒã§ã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
    // æœ¬ç•ªç’°å¢ƒã§ã¯ä»¥ä¸‹ã®è©³ç´°ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    /*
    // æœ¬ç•ªç’°å¢ƒç”¨ã®è©³ç´°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
    // ç¾åœ¨ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ - é–‹ç™ºå®Œäº†å¾Œã«æœ‰åŠ¹åŒ–

    // ðŸ”’ æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆåŸºæœ¬æƒ…å ±ï¼‰
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // å—è«¾æ‹›å¾…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šèª°ã§ã‚‚æ›¸ãè¾¼ã¿å¯èƒ½ï¼ˆæ‹›å¾…å—è«¾ç”¨ï¼‰
      match /acceptedInvitations/{acceptorUid} {
        // ðŸ“ é‡è¦: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚ä½œæˆå¯èƒ½ï¼ˆæ‹›å¾…å—è«¾è¨˜éŒ²ç”¨ï¼‰
        allow create: if request.auth != null &&
                         request.auth.uid == acceptorUid &&
                         request.resource.data.acceptorUid == acceptorUid;

        // èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯æ‹›å¾…å…ƒï¼ˆè¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã®ã¿
        allow read, update, delete: if request.auth != null &&
                                       request.auth.uid == userId;
      }
    }

    // PurchaseGroupï¼šallowedUidsãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /purchaseGroups/{groupId} {
      allow read: if request.auth != null && (
        resource.data.ownerUid == request.auth.uid ||
        request.auth.uid in resource.data.allowedUids
      );

      allow write, update: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;

      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid;

      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;
    }

    // ShoppingListï¼šallowedUidsãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /shoppingLists/{listId} {
      allow read, write: if request.auth != null && (
        resource.data.ownerUid == request.auth.uid ||
        request.auth.uid in resource.data.allowedUids
      );

      allow create: if request.auth != null &&
        request.resource.data.ownerUid == request.auth.uid;

      allow delete: if request.auth != null &&
        resource.data.ownerUid == request.auth.uid;
    }

    // ãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•°ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
    function existsInMembersList(members, uid) {
      return members.where('memberId', '==', uid).size() > 0;
    }

    function hasGroupAccess(groupId, uid) {
      let group = get(/databases/$(database)/documents/purchaseGroups/$(groupId));
      return group.data.ownerUid == uid ||
             uid in group.data.allowedUids;
    }
    */
  }
}
