# Go Shop 開発計画

## 開発フェーズ

### Phase 1: 基盤整備 (現在)
**目標**: エラー修正とアプリの基本動作確保

#### 完了済み
- ✅ プロジェクト構成・依存関係設定
- ✅ データモデル設計（Freezed + Hive）
- ✅ 基本認証システム（Firebase Auth）
- ✅ Repository パターン実装（Hive）
- ✅ 基本UI レイアウト
- ✅ 買い物リスト永続化バグ修正（2件）
  - 混在キー戦略の統一
  - マイグレーション再実行バグ修正
- ✅ 招待機能実装（完了 2025-11-07）
  - モデル層（Invitation with Freezed + Firestore）
  - リポジトリ層（FirestoreInvitationRepository）
  - プロバイダー層（Riverpod状態管理）
  - UI層（QR生成・スキャン、手動入力）
- ✅ Firebase環境構築
  - プロジェクト: gotoshop-572b7
  - Firestoreインデックス定義・デプロイ
  - Firebase CLI設定

#### 進行中
- 🔄 招待機能の動作テスト
  - Firestoreインデックス構築待ち（2-5分）
  - Android実機での動作確認
  - マルチユーザーテスト

#### 残作業
- ❌ UI Overflow修正（InvitationManagementDialog）
- ❌ エッジケーステスト（有効期限、最大使用回数）
- ❌ エラーハンドリング強化

### Phase 2: 機能拡張
**目標**: 基本機能の完全実装とマルチユーザー対応

#### 完了済み
- ✅ メンバー招待システム（2025-11-07）
  - QRコード生成・スキャン機能
  - 手動トークン入力
  - 期限付き招待（24時間）
  - 使用回数制限（5人まで）

#### 進行中
- 🔄 招待機能の動作検証
  - インデックス構築完了待ち
  - マルチデバイステスト
  - エッジケーステスト

#### 予定作業
- ShoppingList リアルタイム同期
- エラーハンドリング強化
- UI/UX改善（Overflow修正等）
- ユーザビリティテスト
- プッシュ通知（基礎）

### Phase 3: 本番対応
**目標**: プロダクションレディ状態

#### インフラ
- Firestore Repository実装
- 本番Firebase設定
- セキュリティルール設定
- パフォーマンス最適化

#### 品質保証
- 自動テスト実装
- エラー監視システム
- ログ収集システム
- ドキュメント完成

## 技術的課題と解決策

### 1. Riverpod Generator 不安定性（解決済み）
**問題**: バージョン3.0.0-dev.11で生成エラー
**解決策**:
- ✅ 従来のProvider構文で実装完了
- Generator無効化で安定動作
- 将来的に安定版移行を検討

### 2. Firestoreインデックス管理（対応完了）
**問題**: 複合クエリにインデックスが必要
**解決策**:
- ✅ `firestore.indexes.json` でインデックス定義
- ✅ Firebase CLI でデプロイ自動化
- ✅ プロジェクト: gotoshop-572b7
- ⏳ インデックス構築完了待ち（2-5分）

### 3. データレイヤー設計
**問題**: Hive⇔Firestore切り替え
**解決策**:
- ✅ Repository パターンで抽象化完了
- ✅ Flavor による環境切り替え実装済み
- ✅ 招待機能でFirestore実装完了

### 4. 状態管理複雑性
**問題**: 複数のプロバイダー間の依存関係
**解決策**:
- ✅ プロバイダー階層の明確化
- ✅ Family Providerによるグループ別状態管理
- AsyncNotifierProvider パターンの統一## アーキテクチャ決定記録

### ADR-001: Riverpod 採用理由
- **決定**: Riverpod 3.0 を状態管理ライブラリとして採用
- **理由**:
  - Provider の進化版
  - Compile-time safety
  - Code generation対応
  - Null safety完全対応
- **代替案**: Bloc, Provider, GetX
- **結果**: コード生成エラーにより一部従来手法に回帰

### ADR-002: Repository Pattern 採用
- **決定**: データアクセス層にRepository Pattern導入
- **理由**:
  - データソース（Hive/Firestore）の切り替え容易性
  - テスタビリティ向上
  - 関心事の分離
- **代替案**: 直接データアクセス
- **結果**: 開発・本番環境の切り替えが容易

### ADR-003: Freezed + Hive 組み合わせ
- **決定**: Freezedでイミュターブルクラス、Hiveでローカル永続化
- **理由**:
  - 型安全性
  - コード生成による生産性
  - ローカルファーストアーキテクチャ
- **代替案**: JSON + SharedPreferences, Sqflite
- **結果**: 開発体験良好、型安全性確保

### ADR-004: QRコード招待システム採用（2025-11-07）
- **決定**: QRコード + 手動入力の2方式による招待システム
- **理由**:
  - ユーザビリティ（QRスキャンは直感的）
  - オフライン対応（手動入力で代替可能）
  - セキュリティ（UUID v4 + 期限付きトークン）
- **実装**:
  - パッケージ: qr_flutter 4.1.0, mobile_scanner 5.2.3, uuid 4.5.1
  - 有効期限: 24時間
  - 最大使用回数: 5人/招待
- **代替案**: メール招待、SMS、ディープリンク
- **結果**: 実装完了、動作テスト待ち

### ADR-005: Firebase CLI によるインフラ管理
- **決定**: Firebase CLI を使用したインフラストラクチャコード管理
- **理由**:
  - バージョン管理可能（firestore.indexes.json等）
  - デプロイ自動化
  - チーム開発対応
- **ツール**: Node.js + firebase-tools
- **結果**: インデックス定義の Git 管理とデプロイ自動化達成

## 品質目標

### パフォーマンス
- アプリ起動時間: 3秒以内
- リスト表示: 1秒以内（100アイテム）
- データ同期: 5秒以内

### 可用性
- オフライン機能: 基本操作100%対応
- エラー回復: 自動リトライ実装
- データ整合性: conflict resolution実装

### セキュリティ
- 認証: Firebase Auth使用
- データ暗号化: Firestore標準暗号化
- プライバシー: ローカルデータ暗号化

## リリース計画

### v0.9.0 - 招待機能ベータ版（現在）
**リリース予定**: 2025年11月上旬
**状況**: 実装完了、テスト中
**機能**:
- ✅ ユーザー認証
- ✅ グループ作成・管理
- ✅ メンバー管理
- ✅ 買い物リスト永続化
- ✅ QR/手動招待システム
- ⏳ Firestoreインデックス構築中

### v1.0.0 - 基本機能版
**リリース予定**: Phase 2完了後（2025年11月中旬予定）
**機能**:
- ✅ ユーザー認証
- ✅ グループ作成・管理
- ✅ メンバー管理・招待
- ✅ 基本買い物リスト
- ✅ ローカル保存
- 🔄 Firestore同期
- 🔄 リアルタイム更新
- ❌ エラー回復機能

### v1.1.0 - 同期機能強化版
**リリース予定**: Phase 3完了後
**機能**:
- プッシュ通知
- オフライン対応強化
- パフォーマンス最適化
- エラー監視システム

### v2.0.0 - 高機能版
**リリース予定**: Phase 4
**機能**:
- 高度なフィルタリング
- 統計機能
- エクスポート機能
- 多言語対応
- テーマカスタマイズ

## 開発リソース

### 必要スキル
- Flutter/Dart（必須）
- Firebase（必須）
- 状態管理（Riverpod）
- データベース設計
- UI/UX デザイン

### 開発環境
- VS Code + Flutter拡張
- Android Studio（テスト用）
- Firebase Console
- Git/GitHub

### テスト環境
- Android Emulator
- Android実機（SH 54D, Android 15） ✅
- iOS Simulator（将来）
- 実機テスト（複数デバイス対応）

### 開発ツール追加（2025-11-07）
- Node.js (Chocolatey経由)
- Firebase CLI (npm)
- Git/GitHub
- ワイヤレスADB接続

## 現在の優先タスク（2025-11-12更新）

### リファクタリング進行中 🔄

#### 完了済み ✅
1. **共通サービス抽出** (Step 2)
   - SyncService作成: 314行、Firestore⇔Hive同期ロジック統一
   - ErrorHandler作成: 4メソッド、エラーハンドリングパターン統一

2. **プロバイダー統一** (設計改善)
   - currentGroupProviderとselectedGroupIdProviderの二重管理を解消
   - selectedGroupIdProviderに統一（使用頻度と軽量性を考慮）
   - 影響ファイル: 6ファイル修正、1ファイル削除
   - 効果: 同期バグの構造的原因を排除、コード-66行削減

3. **バグ修正**
   - グループ作成時のUI同期問題を解決
   - グループ削除時の状態クリア実装
   - 削除済みグループのフィルタリング強化

#### 進行中 🔄
- **UserInitializationServiceの移行**
  - 現状: SyncService/ErrorHandlerのimport済み
  - 次回: _syncSpecificGroupFromFirestoreをSyncService.syncSpecificGroupに置き換え
  - 期待効果: 約500行のコード削減

#### 次回タスク 📋
1. **UserInitializationService移行完了** (P0)
   - syncHiveToFirestore → SyncService使用
   - syncFromFirestoreToHive → SyncService使用
   - エラーハンドリングをErrorHandlerに統一

2. **NotificationService移行** (P1)
   - 同様のパターンでSyncService活用

3. **リファクタリング完了後の動作検証** (P0)
   - Firestore同期の正常動作確認
   - エラーハンドリングの動作確認
   - 全画面遷移の動作確認

### リファクタリング進捗
```
Step 1: サービス抽出準備        [████████████████████] 100% ✅
Step 2: 共通ロジック抽出        [████████████████░░░░]  80% 🔄
  - SyncService作成            [████████████████████] 100% ✅
  - ErrorHandler作成           [████████████████████] 100% ✅
  - UserInitService移行        [░░░░░░░░░░░░░░░░░░░░]   0% 📋
  - NotificationService移行    [░░░░░░░░░░░░░░░░░░░░]   0% 📋
Step 3: Provider簡素化         [░░░░░░░░░░░░░░░░░░░░]   0%
Step 4: 冗長コード削除          [░░░░░░░░░░░░░░░░░░░░]   0%
Step 5: ドキュメント更新        [░░░░░░░░░░░░░░░░░░░░]   0%
```

### 品質向上の成果
- **技術的負債の返済**: 二重管理プロバイダーを根本解決
- **バグ予防**: 構造的な同期漏れリスクを排除
- **コード品質**: 単一責任原則の徹底、状態管理の明確化
- **開発速度**: 更新箇所が半減、デバッグが容易に

---

### 招待機能（Phase 2）- 保留中
*リファクタリング完了後に再テスト予定*

### 短期改善（Phase 2後）
- UI Overflow修正
- エッジケーステスト実施
- エラーハンドリング強化

---

*最終更新: 2025年11月12日*
*この開発計画は進捗に応じて随時更新されます。*
