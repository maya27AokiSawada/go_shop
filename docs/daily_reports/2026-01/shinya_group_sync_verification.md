# しんやさんグループ同期確認レポート

**確認日時**: 2026年1月26日
**確認者**:
**確認デバイス**: Pixel 9 (しんや)

---

## 概要

共有グループ同期機能の修正（`createDefaultGroup()`でデフォルトグループのみでなく全グループをFirestoreから同期）が正しく動作しているか確認します。

### 修正内容の確認

修正前の問題:

```
- createDefaultGroup()がデフォルトグループのみをHiveに同期
- 共有グループ（すもも共有グループ）がHiveに含まれない
- Firebaseコンソールでは存在するが、アプリに表示されない
```

修正後の期待動作:

```
✅ Firestoreから全グループを取得
✅ 全グループをHiveに同期
✅ デフォルトグループ + 共有グループが全て表示される
```

---

## チェックリスト

### Phase 1: ユーザー情報の確認

| 確認項目                 | 結果 | メモ |
| ------------------------ | ---- | ---- |
| 現在ログイン中のユーザー | ☐    |      |
| ユーザーUID              | ☐    |      |
| ユーザー表示名           | ☐    |      |

**ユーザーUID**:
**ユーザー表示名**:

---

### Phase 2: Firestore内のグループ確認

| グループ名 | groupId | ownerUid | allowedUid (人数) | allowedUid に shinya含む | 備考 |
| ---------- | ------- | -------- | ----------------- | ------------------------ | ---- |
|            |         |          |                   | ☐                        |      |
|            |         |          |                   | ☐                        |      |
|            |         |          |                   | ☐                        |      |

**Firestore確認方法**:

```
Firebase Console → Cloud Firestore → SharedGroups コレクション
→ allowedUid に現在のユーザーUID が含まれるドキュメントを確認
```

**特に確認すべき項目**:

- [ ] 「すもも共有グループ」が Firestore に存在するか
- [ ] そのグループの allowedUid に shinya のUID が含まれているか
- [ ] ownerUid は誰か（すもも？）

**Firestore検索結果**:

```
[ここに検索結果をコピー]
```

---

### Phase 3: Hive内のグループ確認

**デバイスログから確認**:

```bash
# アプリの詳細ログを確認
adb logcat -s GoShopping | grep "CREATE DEFAULT"
```

**期待されるログ出力**:

```
✅ [CREATE DEFAULT] Firestore→Hive同期: すもも共有グループ (groupId)
✅ [CREATE DEFAULT] Firestore→Hive同期: シニア個人用グループ (uid)
✅ [CREATE DEFAULT] 2グループをHiveに同期完了
```

**実際のログ**:

```
[ここにログをコピー]
```

---

### Phase 4: アプリUI上での確認

| 確認項目                                 | 結果 | メモ |
| ---------------------------------------- | ---- | ---- |
| ログイン後、グループリストが表示される   | ☐    |      |
| デフォルトグループ（個人用）が表示される | ☐    |      |
| すもも共有グループが表示される           | ☐    |      |
| その他のグループが表示される             | ☐    |      |
| グループ数が Firestore と一致            | ☐    |      |

**表示されているグループ一覧**:

1.
2.
3.

**期待値との比較**:

- Firestore上のグループ数:
- Hive上のグループ数:
- アプリUI上のグループ数:

---

### Phase 5: グループメンバー確認

**対象グループ**: すもも共有グループ

| メンバー名 | UID | 表示ステータス | メモ |
|----------|-----||
| | | ☐ 正常 / ☐ エラー | |
| | | ☐ 正常 / ☐ エラー | |

**期待値**:

- オーナー: すもも
- メンバー: shinya（今回のテスト対象）

**実際**:

- オーナー:
- メンバー:

---

### Phase 6: 同期の完全性確認

| 確認項目   | Firestore | Hive | UI表示 | 一致 |
| ---------- | --------- | ---- | ------ | ---- |
| グループ数 |           |      |        | ☐    |
| グループ名 |           |      |        | ☐    |
| メンバー数 |           |      |        | ☐    |
| allowedUid |           |      |        | ☐    |

---

## 問題発見時の対応

### 問題1: グループが表示されない場合

**チェックステップ**:

1. [ ] Firestore Console で allowedUid を確認
2. [ ] デバッグログで「CREATE DEFAULT」の出力を確認
3. [ ] Hive Box の内容をダンプして確認
4. [ ] SharedPreferences のユーザーUID が正しいか確認

**想定原因**:

- UID が一致していない（iOS と Android で異なる可能性）
- Hive Box がクリアされていない
- `allowedUid` の比較がバイナリレベルで失敗

**復旧方法**:

```dart
// アプリ内でこれを実行
await SharedGroupBox.clear();
ref.invalidate(allGroupsProvider);
await ref.read(forceSyncProvider.future);
```

---

### 問題2: グループ数が一致しない場合

**想定原因**:

- `createDefaultGroup()` でデフォルトグループのみが同期されている（修正前の挙動）
- Hive に古いキャッシュが残っている
- ネットワーク不具合で Firestore 同期が失敗

**復旧方法**:

```dart
// Hive をクリアして再同期
await SharedGroupBox.clear();
ref.invalidate(allGroupsProvider);
// ホーム画面に戻る
// 再度グループ一覧を開く
```

---

### 問題3: メンバー表示がエラーになる場合

**チェック項目**:

- [ ] Firestore の `/users/{uid}/profile/profile` ドキュメントが存在するか
- [ ] `displayName` フィールドが存在するか
- [ ] Firestore ルールで読み取り権限があるか

**復旧方法**:

```dart
// Firestore Rules の確認
match /users/{document=**} {
  allow read, write: if request.auth.uid == resource.data.ownerUid ||
                        request.auth.uid in resource.data.allowedUid;
}
```

---

## テスト成功のための必須条件

✅ **成功判定**:

- [ ] Firestore上のグループが全て Hive に同期される
- [ ] グループ数が一致している
- [ ] すもも共有グループがアプリに表示される
- [ ] メンバーの名前が正しく表示される
- [ ] デバッグログに「✅ [CREATE DEFAULT] 全グループをHiveに同期完了」が出力される

❌ **失敗判定**:

- グループが表示されない
- グループ数が一致しない
- メンバー表示にエラーがある

---

## 追加確認項目（オプション）

### マルチデバイス確認

- [ ] すもも (Pixel 9) でアプリを開く → グループが表示されるか
- [ ] shinya (SH 54D) でアプリを開く → 共有グループが表示されるか
- [ ] 一方でグループメンバーを追加 → もう一方で同期されるか

### バックグラウンド同期確認

- [ ] アプリをバックグラウンドに送る
- [ ] 5分待機
- [ ] アプリを再度開く
- [ ] グループが同期されているか確認

---

## 検査結果

### 総合判定

- [ ] ✅ 成功：修正が正常に機能している
- [ ] ⚠️ 部分的成功：いくつかの問題がある
- [ ] ❌ 失敗：修正が機能していない

### 詳細

**成功した項目**:

1.
2.
3.

**失敗した項目**:

1.
2.
3.

**推奨アクション**:

---

**検査完了日時**: 2026年1月26日
**次回確認予定日**:
