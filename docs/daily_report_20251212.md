# Go Shop - æ—¥å ± (2025å¹´12æœˆ12æ—¥)

## ğŸ“… æœ¬æ—¥ã®ä½œæ¥­æ¦‚è¦

**ä½œæ¥­æœŸé–“**: 2025å¹´12æœˆ12æ—¥
**ä¸»ãªæˆæœ**: Firestoreæ›¸ãè¾¼ã¿å¤±æ•—å•é¡Œã®æ ¹æœ¬åŸå› ç‰¹å®šã¨ä¿®æ­£å®Œäº†

---

## ğŸ¯ å®Ÿè£…é …ç›®

### 1. Firestoreãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ä½œæˆæ©Ÿèƒ½ âœ…

**ç›®çš„**: æ—§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«Firestoreãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¬ è½ã—ã¦ã„ã‚‹å•é¡Œã®è§£æ±º

**å®Ÿè£…å†…å®¹**:
- `FirestoreUserNameService.saveUserName()`: `SetOptions(merge: true)`ã§è‡ªå‹•ä½œæˆ
- `FirestoreUserNameService.ensureUserProfileExists()`: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åŒæœŸãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- Firebase Auth email â†’ Firestore profile email æ¯”è¼ƒãƒ»æ›´æ–°æ©Ÿèƒ½

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- `lib/services/firestore_user_name_service.dart` (L48-230)

---

### 2. Windows Desktop Firestore ã‚¹ãƒ¬ãƒƒãƒ‰å•é¡Œå¯¾å¿œ âš ï¸

**å•é¡Œ**:
```
[ERROR:flutter/shell/common/shell.cc(1178)] The 'ui' isolate has called a non-platform thread task on a platform thread.
```

**åˆæœŸå¯¾å¿œ**: ã™ã¹ã¦ã®Firestoreæ›¸ãè¾¼ã¿æ“ä½œã‚’`Future.microtask()`ã§ãƒ©ãƒƒãƒ—

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- `lib/services/firestore_user_name_service.dart`
- `lib/datastore/firestore_shared_list_repository.dart`
- `lib/datastore/firestore_purchase_group_repository.dart`

**çµæœ**: âš ï¸ ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼ã¯è»½æ¸›ã•ã‚ŒãŸãŒã€**ãƒªã‚¹ãƒˆãŒFirestoreã«æ›¸ãè¾¼ã¾ã‚Œãªã„å•é¡Œã¯æœªè§£æ±º**

---

### 3. æ ¹æœ¬åŸå› ç‰¹å®š: Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å•é¡Œ ğŸ”¥

**ç™ºè¦‹**:
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œã‚„ã£ã±ã‚ŠsharedListsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒä½œã‚‰ã‚Œã¾ã›ã‚“ã€ã¨ã®å ±å‘Šå¾Œã€ãƒ­ã‚°åˆ†æã§çœŸã®åŸå› ã‚’ç™ºè¦‹

**ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**:
```
âŒ [REALTIME] Streamã‚¨ãƒ©ãƒ¼: [cloud_firestore/permission-denied] Missing or insufficient permissions
```

**çœŸã®åŸå› **:
- `firestore.rules`ã®`isGroupMember()`é–¢æ•°ãŒ`resource.data`ã‚’ä½¿ç”¨
- **æ–°è¦subcollectionä½œæˆæ™‚ã«ã¯`resource`ãŒå­˜åœ¨ã—ãªã„**
- â†’ æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒå¸¸ã«å¤±æ•—

**å•é¡Œã®ã‚³ãƒ¼ãƒ‰** (firestore.rules L96-113):
```
function isGroupMember(groupId) {
  return request.auth != null && (
    resource.data.ownerUid == request.auth.uid ||  // âŒ resource.dataãŒå­˜åœ¨ã—ãªã„
    request.auth.uid in resource.data.allowedUid
  );
}

match /sharedLists/{listId} {
  allow read, write: if isGroupMember(groupId);  // âŒ å¸¸ã«å¤±æ•—
}
```

---

### 4. ä¿®æ­£å®Ÿè£…: ç›´æ¥å‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›´ âœ…

**è§£æ±ºç­–**: `resource.data`ã®ä»£ã‚ã‚Šã«`get()`é–¢æ•°ã§è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç›´æ¥å–å¾—

**ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰** (firestore.rules L96-113):
```
match /sharedLists/{listId} {
  allow read, create, update, delete: if request.auth != null && (
    get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.ownerUid == request.auth.uid ||
    request.auth.uid in get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
  );
}
```

**ãƒ‡ãƒ—ãƒ­ã‚¤**:
```bash
firebase deploy --only firestore:rules
âœ… cloud.firestore: rules file firestore.rules compiled successfully
âœ… firestore: released rules firestore.rules to cloud.firestore
```

---

## ğŸ‰ æ¤œè¨¼çµæœ

### ãƒ†ã‚¹ãƒˆå®Ÿæ–½å†…å®¹

**ç’°å¢ƒ**: Windows Desktopç‰ˆã‚¢ãƒ—ãƒª

**æ‰‹é †**:
1. ã‚¢ãƒ—ãƒªå†èµ·å‹•
2. æ–°ã—ã„ãƒªã‚¹ãƒˆä½œæˆ
3. ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
4. Firestore Consoleã§ç¢ºèª

**çµæœ**:
- âœ… **UIã«å³åº§ã«è¡¨ç¤º** (Hive ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¸ã®ä¿å­˜)
- âœ… **æ•°ç§’é…ã‚Œã¦Firestoreã«åæ˜ ** (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒæœŸ)
- âœ… `[cloud_firestore/permission-denied]`ã‚¨ãƒ©ãƒ¼æ¶ˆå¤±
- âœ… Firestore Console ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèªå¯èƒ½

---

## ğŸ“Š æŠ€è¡“çš„å­¦ã³

### 1. ãƒ‡ãƒãƒƒã‚°ã®é‡è¦æ€§

**æ•™è¨“**: ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç›®ç«‹ã¤ãŒã€å®Ÿéš›ã®æ ¹æœ¬åŸå› ã¯åˆ¥ã®å ´æ‰€ã«ã‚ã‚‹å ´åˆãŒã‚ã‚‹

**åˆ†ææ‰‹é †**:
1. è¡¨é¢çš„ãªã‚¨ãƒ©ãƒ¼ (ã‚¹ãƒ¬ãƒƒãƒ‰è­¦å‘Š) ã«æƒ‘ã‚ã•ã‚Œãš
2. ãƒ­ã‚°ã®è©³ç´°ã‚’åˆ†æ (permission-denied)
3. Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
4. `resource.data`ã®å­˜åœ¨æ¡ä»¶ã‚’ç†è§£

### 2. Firestore Security Rules ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

**èª¤ã‚Š**: ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã«`resource.data`ã‚’ä½¿ç”¨
```javascript
// âŒ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ™‚ã¯ resource ãŒå­˜åœ¨ã—ãªã„
resource.data.allowedUid
```

**æ­£è§£**: è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç›´æ¥å–å¾—
```javascript
// âœ… è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å¸¸ã«å­˜åœ¨ã™ã‚‹
get(/databases/$(database)/documents/SharedGroups/$(groupId)).data.allowedUid
```

### 3. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å‹•ä½œç¢ºèª

**è¨­è¨ˆé€šã‚Šã®å‹•ä½œ**:
1. **Hive**: ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (å³åº§ã«åæ˜ )
2. **Firestore**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒæœŸ (1-3ç§’é…å»¶)

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‘ä¸Š
- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–

---

## ğŸ”§ æŠ€è¡“çš„è©³ç´°

### Future.microtask()ã®åŠ¹æœ

**ç›®çš„**: Windows Desktop Firestoreã®ã‚¹ãƒ¬ãƒƒãƒ‰å•é¡Œã‚’è»½æ¸›

**å®Ÿè£…ç®‡æ‰€**:
```dart
await Future.microtask(() async {
  await docRef.set(dataToSave, SetOptions(merge: true));
});
```

**åŠ¹æœ**:
- âœ… ã‚¹ãƒ¬ãƒƒãƒ‰è­¦å‘Šã®é »åº¦æ¸›å°‘
- âš ï¸ ãƒ‡ãƒ¼ã‚¿æå¤±ã¯é˜²ã’ã¦ã„ãªã‹ã£ãŸ (permissionså•é¡ŒãŒåŸå› )
- ğŸ’¡ å°†æ¥çš„ã«ã¯æœ‰ç”¨ãªå¯¾ç­–

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

### Before (å•é¡Œç™ºç”Ÿæ™‚)

```
1. UI: ãƒªã‚¹ãƒˆä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
2. Hive: å³åº§ã«ä¿å­˜ âœ…
3. Firestore: permission-denied âŒ
4. çµæœ: ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã€ä»–ãƒ‡ãƒã‚¤ã‚¹ã§è¡¨ç¤ºã•ã‚Œãªã„
```

### After (ä¿®æ­£å¾Œ)

```
1. UI: ãƒªã‚¹ãƒˆä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
2. Hive: å³åº§ã«ä¿å­˜ âœ… (< 100ms)
3. Firestore: æ¨©é™ãƒã‚§ãƒƒã‚¯OK â†’ æ›¸ãè¾¼ã¿æˆåŠŸ âœ… (1-3ç§’)
4. çµæœ: ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã§åŒæœŸ
```

---

## ğŸš€ ä»Šå¾Œã®å±•æœ›

### çŸ­æœŸçš„æ”¹å–„ (æ¬¡å›ã‚»ãƒƒã‚·ãƒ§ãƒ³)

1. **Androidå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ**
   - è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸç¢ºèª
   - ã™ã‚‚ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ (Android) ã¨ã®é€£æºãƒ†ã‚¹ãƒˆ

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„
   - ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**
   - Firestoreæ›¸ãè¾¼ã¿æ™‚é–“ã®è¨ˆæ¸¬
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ç‡ã®è¿½è·¡

### ä¸­æœŸçš„æ”¹å–„

1. **Firestore Rules æœ€é©åŒ–**
   - è¤‡æ•°ã®`get()`å‘¼ã³å‡ºã—ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - èª­ã¿å–ã‚Šå›æ•°ã‚’å‰Šæ¸›

2. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œå¼·åŒ–**
   - ã‚­ãƒ¥ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£…
   - åŒæœŸå¤±æ•—æ™‚ã®å†è©¦è¡Œãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™**
   - Firestore Rules ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æ–‡æ›¸åŒ–
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ä½œæˆ

---

## ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« (3ä»¶)

1. **firestore.rules**
   - L96-113: sharedListsãƒãƒƒãƒãƒ–ãƒ­ãƒƒã‚¯ä¿®æ­£
   - `resource.data` â†’ `get()` é–¢æ•°ã«å¤‰æ›´

2. **lib/services/firestore_user_name_service.dart**
   - L48-106: `saveUserName()` - `Future.microtask()` + emailåŒæœŸ
   - L163-230: `ensureUserProfileExists()` - ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ä½œæˆ

3. **lib/datastore/firestore_shared_list_repository.dart**
   - L37-102: ã™ã¹ã¦ã®Firestoreæ“ä½œã‚’`Future.microtask()`ã§ãƒ©ãƒƒãƒ—

---

## ğŸ“ å­¦ã‚“ã ã“ã¨

1. **è¡¨é¢çš„ãªã‚¨ãƒ©ãƒ¼ã«æƒ‘ã‚ã•ã‚Œãªã„**
   - ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç›®ç«‹ã¤ãŒã€çœŸã®åŸå› ã¯æ¨©é™å•é¡Œã ã£ãŸ

2. **Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®æ·±ã„ç†è§£**
   - `resource.data`ã®å­˜åœ¨æ¡ä»¶ã‚’ç†è§£
   - ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã®æ³¨æ„ç‚¹

3. **æ®µéšçš„ãƒ‡ãƒãƒƒã‚°ã®é‡è¦æ€§**
   - ãƒ­ã‚°åˆ†æ â†’ ä»®èª¬æ¤œè¨¼ â†’ åŸå› ç‰¹å®š â†’ ä¿®æ­£ â†’ æ¤œè¨¼

4. **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¾¡å€¤**
   - ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å³åº§ã«UIæ›´æ–°
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ„Ÿã˜ã•ã›ãªã„

---

## âœ… å®Œäº†ã‚¿ã‚¹ã‚¯

- [x] Firestoreãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ä½œæˆæ©Ÿèƒ½
- [x] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åŒæœŸæ©Ÿèƒ½
- [x] Windows Firestoreã‚¹ãƒ¬ãƒƒãƒ‰å•é¡Œã®è»½æ¸›
- [x] æ ¹æœ¬åŸå› ã®ç‰¹å®š (permissions)
- [x] Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ä¿®æ­£
- [x] ãƒ«ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [x] ä¿®æ­£ã®æ¤œè¨¼ãƒ»å‹•ä½œç¢ºèª

---

## ğŸ”œ æ¬¡å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®äºˆå®š

1. Androidå®Ÿæ©Ÿã§ã®ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹åŒæœŸãƒ†ã‚¹ãƒˆ
2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
3. æ—¥å ±ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™
4. mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸

---

## ğŸ“Œ ãƒ¡ãƒ¢

- Firebase CLIæ›´æ–°åˆ©ç”¨å¯èƒ½: 14.24.0 â†’ 14.27.0 (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- ã‚¹ãƒ¬ãƒƒãƒ‰è­¦å‘Šã¯æ®‹ã‚‹ãŒã€ãƒ‡ãƒ¼ã‚¿æå¤±ã¯ç™ºç”Ÿã—ãªã„ (éã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«)
- ä»Šå¾Œã‚‚ãƒ­ã‚°ç›£è¦–ã‚’ç¶™ç¶šã—ã€ç•°å¸¸ãŒãªã„ã‹ç¢ºèª

---

**ä½œæˆè€…**: GitHub Copilot
**æ—¥æ™‚**: 2025å¹´12æœˆ12æ—¥
