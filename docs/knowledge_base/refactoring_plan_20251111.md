# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”» - ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

## ğŸ¯ ç›®æ¨™

### ä¸»è¦ç›®æ¨™

1. **ã‚³ãƒ¼ãƒ‰å‰Šæ¸›**: 5,000 è¡Œ â†’ 4,000 è¡Œï¼ˆ-20%ï¼‰
2. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 0% â†’ 60%
3. **å¹³å‡ãƒ¡ã‚½ãƒƒãƒ‰é•·**: 40 è¡Œ â†’ 20 è¡Œ
4. **é‡è¤‡ã‚³ãƒ¼ãƒ‰**: 15% â†’ 5%

### å“è³ªç›®æ¨™

- âœ… ãƒ¡ã‚½ãƒƒãƒ‰ã®å˜ä¸€è²¬ä»»åŸå‰‡ï¼ˆSRPï¼‰
- âœ… DRY åŸå‰‡ã®å¾¹åº•
- âœ… å‹å®‰å…¨æ€§ã®å‘ä¸Š
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

---

## ğŸ“… å®Ÿæ–½ã‚¹ãƒ†ãƒƒãƒ—

### ç¬¬ 1 ã‚¹ãƒ†ãƒƒãƒ—: åˆ†æã¨ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°

- [ ] ã‚³ãƒ¼ãƒ‰åˆ†æãƒ„ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆdart analyzeï¼‰
- [ ] é‡è¤‡ã‚³ãƒ¼ãƒ‰æ¤œå‡º
- [ ] é•·ã„ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
- [ ] ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å„ªå…ˆåº¦ã®æ±ºå®š

### ç¬¬ 2 ã‚¹ãƒ†ãƒƒãƒ—: å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã®æŠ½å‡º

- [ ] SyncService ã®ä½œæˆ
- [ ] ErrorHandler ã®ä½œæˆ
- [ ] RepositoryFactory ã®ä½œæˆ
- [ ] æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ç§»è¡Œ

### ç¬¬ 3 ã‚¹ãƒ†ãƒƒãƒ—: å‹å®‰å…¨æ€§ã®å‘ä¸Š

- [ ] NotificationMetadata ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] InvitationData ã‚¯ãƒ©ã‚¹ä½œæˆ
- [ ] Result å‹ã®å°å…¥ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
- [ ] æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å‹å¤‰æ›

### ç¬¬ 4 ã‚¹ãƒ†ãƒƒãƒ—: ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆservices/ï¼‰
- [ ] Widget ãƒ†ã‚¹ãƒˆï¼ˆwidgets/ï¼‰
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆinvitation flowï¼‰
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

### ç¬¬ 5 ã‚¹ãƒ†ãƒƒãƒ—: æœ€é©åŒ–ã¨ä»•ä¸Šã’

- [ ] Firestore ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…
- [ ] ãƒ­ã‚°ç®¡ç†ã®çµ±ä¸€
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

---

## ğŸ”§ è©³ç´°ã‚¿ã‚¹ã‚¯

## ç¬¬ 1 ã‚¹ãƒ†ãƒƒãƒ—: åˆ†æã¨ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°

### Task 1.1: ã‚³ãƒ¼ãƒ‰åˆ†æ

```bash
# é™çš„è§£æ
flutter analyze

# é‡è¤‡ã‚³ãƒ¼ãƒ‰æ¤œå‡º
dart run jscpd lib/

# ã‚³ãƒ¼ãƒ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹
dart run dart_code_metrics:metrics analyze lib/
```

### Task 1.2: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã®ç‰¹å®š

**é•·ã„ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ40 è¡Œä»¥ä¸Šï¼‰:**

```
lib/services/qr_invitation_service.dart:
  - acceptQRInvitation() [100è¡Œ]
  - _processIndividualInvitation() [80è¡Œ]
  - _processFriendInvitation() [90è¡Œ]

lib/services/notification_service.dart:
  - _handleNotification() [80è¡Œ]
  - sendNotificationToGroup() [70è¡Œ]

lib/services/user_initialization_service.dart:
  - syncFromFirestoreToHive() [120è¡Œ]
  - _initializeUserDefaults() [60è¡Œ]
```

**é‡è¤‡ã‚³ãƒ¼ãƒ‰:**

```
Firestoreå–å¾—å‡¦ç†:
  - UserInitializationService.syncFromFirestoreToHive()
  - NotificationService._syncSpecificGroupFromFirestore()

ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
  - å„ã‚µãƒ¼ãƒ“ã‚¹ã§åŒæ§˜ã®try-catch-log

Hiveæ“ä½œ:
  - è¤‡æ•°ç®‡æ‰€ã§Boxå–å¾—ã¨Put/Getå‡¦ç†
```

---

## ç¬¬ 2 ã‚¹ãƒ†ãƒƒãƒ—: å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã®æŠ½å‡º

### Task 2.1: SyncService ã®ä½œæˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/services/sync_service.dart`

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/shared_group.dart';
import '../datastore/shared_group_repository.dart';

final syncServiceProvider = Provider<SyncService>((ref) {
  return SyncService(ref);
});

/// ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚µãƒ¼ãƒ“ã‚¹
/// Firestore â‡„ Hive ã®åŒæœŸã‚’ä¸€å…ƒç®¡ç†
class SyncService {
  final Ref _ref;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  SyncService(this._ref);

  SharedGroupRepository get _repository =>
      _ref.read(SharedGroupRepositoryProvider);

  /// å…¨ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åŒæœŸ
  Future<void> syncAllGroups(User user) async {
    final groups = await _fetchGroupsFromFirestore(user);
    await _updateLocalGroups(groups);
  }

  /// ç‰¹å®šã‚°ãƒ«ãƒ¼ãƒ—ã‚’åŒæœŸ
  Future<void> syncSpecificGroup(String groupId) async {
    final group = await _fetchGroupFromFirestore(groupId);
    if (group != null) {
      await _repository.updateGroup(groupId, group);
    }
  }

  /// å·®åˆ†åŒæœŸï¼ˆæœ€çµ‚åŒæœŸæ—¥æ™‚ä»¥é™ã®å¤‰æ›´ã®ã¿ï¼‰
  Future<void> syncDelta(User user, DateTime since) async {
    final groups = await _fetchGroupsFromFirestore(
      user,
      where: (query) => query.where('lastUpdated', isGreaterThan: since),
    );
    await _updateLocalGroups(groups);
  }

  /// Firestoreã‹ã‚‰å…¨ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
  Future<List<SharedGroup>> _fetchGroupsFromFirestore(
    User user, {
    Query<Map<String, dynamic>> Function(Query<Map<String, dynamic>>)? where,
  }) async {
    var query = _firestore
        .collection('SharedGroups')
        .where('allowedUid', arrayContains: user.uid);

    if (where != null) {
      query = where(query);
    }

    final snapshot = await query.get();
    return snapshot.docs
        .map((doc) => SharedGroup.fromJson(doc.data()))
        .toList();
  }

  /// Firestoreã‹ã‚‰ç‰¹å®šã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
  Future<SharedGroup?> _fetchGroupFromFirestore(String groupId) async {
    final doc = await _firestore
        .collection('SharedGroups')
        .doc(groupId)
        .get();

    if (!doc.exists) return null;
    return SharedGroup.fromJson(doc.data()!);
  }

  /// ãƒ­ãƒ¼ã‚«ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ›´æ–°
  Future<void> _updateLocalGroups(List<SharedGroup> groups) async {
    for (final group in groups) {
      await _repository.updateGroup(group.id, group);
    }
  }
}
```

**ç§»è¡Œä½œæ¥­:**

1. `UserInitializationService` ã®åŒæœŸå‡¦ç†ã‚’ `SyncService` ã«å§”è­²
2. `NotificationService` ã®åŒæœŸå‡¦ç†ã‚’ `SyncService` ã«å§”è­²
3. é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤

### Task 2.2: ErrorHandler ã®ä½œæˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/utils/error_handler.dart`

```dart
import '../utils/app_logger.dart';

/// çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
class ErrorHandler {
  /// éåŒæœŸå‡¦ç†ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  static Future<T?> handleAsync<T>({
    required Future<T> Function() operation,
    required String context,
    T? defaultValue,
    bool rethrow = false,
  }) async {
    try {
      return await operation();
    } catch (e, stackTrace) {
      AppLogger.error('âŒ [$context] ã‚¨ãƒ©ãƒ¼: $e');
      AppLogger.debug('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: $stackTrace');

      if (rethrow) {
        rethrow;
      }
      return defaultValue;
    }
  }

  /// åŒæœŸå‡¦ç†ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  static T? handleSync<T>({
    required T Function() operation,
    required String context,
    T? defaultValue,
    bool rethrow = false,
  }) {
    try {
      return operation();
    } catch (e, stackTrace) {
      AppLogger.error('âŒ [$context] ã‚¨ãƒ©ãƒ¼: $e');
      AppLogger.debug('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: $stackTrace');

      if (rethrow) {
        rethrow;
      }
      return defaultValue;
    }
  }
}
```

**ä½¿ç”¨ä¾‹:**

```dart
// Before
try {
  await sendNotification(...);
} catch (e) {
  AppLogger.error('âŒ [NOTIFICATION] é€ä¿¡ã‚¨ãƒ©ãƒ¼: $e');
}

// After
await ErrorHandler.handleAsync(
  operation: () => sendNotification(...),
  context: 'NOTIFICATION:sendNotification',
);
```

### Task 2.3: RepositoryFactory ã®ä½œæˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/datastore/repository_factory.dart`

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'shared_group_repository.dart';
import 'hive_shared_group_repository.dart';
import '../flavors.dart';

/// ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼
/// ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ã«å¿œã˜ã¦é©åˆ‡ãªãƒªãƒã‚¸ãƒˆãƒªã‚’è¿”ã™
class RepositoryFactory {
  static SharedGroupRepository createSharedGroupRepository(Ref ref) {
    if (F.appFlavor == Flavor.prod) {
      // æœ¬ç•ªç’°å¢ƒ: Firestoreï¼ˆæœªå®Ÿè£…ï¼‰
      throw UnimplementedError('FirestoreSharedGroupRepository');
    } else {
      // é–‹ç™ºç’°å¢ƒ: Hive
      return HiveSharedGroupRepository(ref);
    }
  }
}

// Provider ã®æ›´æ–°
final SharedGroupRepositoryProvider = Provider<SharedGroupRepository>((ref) {
  return RepositoryFactory.createSharedGroupRepository(ref);
});
```

---

## ç¬¬ 3 ã‚¹ãƒ†ãƒƒãƒ—: å‹å®‰å…¨æ€§ã®å‘ä¸Š

### Task 3.1: NotificationMetadata ã®å‹å®šç¾©

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/models/notification_metadata.dart`

```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'notification_metadata.freezed.dart';
part 'notification_metadata.g.dart';

@freezed
class NotificationMetadata with _$NotificationMetadata {
  const factory NotificationMetadata({
    String? groupId,
    String? newMemberId,
    String? newMemberName,
    String? invitationType,
    String? updateType,
    String? oldValue,
    String? newValue,
  }) = _NotificationMetadata;

  factory NotificationMetadata.fromJson(Map<String, dynamic> json) =>
      _$NotificationMetadataFromJson(json);
}
```

**ä½¿ç”¨ä¾‹:**

```dart
// Before
final groupId = notification.metadata?['groupId'] as String?;

// After
final metadata = NotificationMetadata.fromJson(notification.metadata ?? {});
final groupId = metadata.groupId;
```

### Task 3.2: InvitationData ã®å‹å®šç¾©

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/models/invitation_data.dart`

```dart
import 'package:freezed_annotation/freezed_annotation.dart';
import 'package:hive/hive.dart';

part 'invitation_data.freezed.dart';
part 'invitation_data.g.dart';

enum InvitationStatus {
  @HiveField(0)
  pending,
  @HiveField(1)
  accepted,
  @HiveField(2)
  expired,
  @HiveField(3)
  revoked,
}

@freezed
@HiveType(typeId: 5)
class InvitationData with _$InvitationData {
  const factory InvitationData({
    @HiveField(0) required String invitationId,
    @HiveField(1) required String inviterUid,
    @HiveField(2) required String SharedGroupId,
    @HiveField(3) required String groupName,
    @HiveField(4) required String securityKey,
    @HiveField(5) required InvitationStatus status,
    @HiveField(6) required DateTime createdAt,
    @HiveField(7) required DateTime expiresAt,
    @HiveField(8) String? acceptorUid,
    @HiveField(9) DateTime? acceptedAt,
  }) = _InvitationData;

  factory InvitationData.fromJson(Map<String, dynamic> json) =>
      _$InvitationDataFromJson(json);
}
```

### Task 3.3: Result å‹ã®å°å…¥

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/utils/result.dart`

```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'result.freezed.dart';

@freezed
class Result<T> with _$Result<T> {
  const factory Result.success(T data) = Success<T>;
  const factory Result.failure(String error, [StackTrace? stackTrace]) = Failure<T>;
}
```

**ä½¿ç”¨ä¾‹:**

```dart
// Before
Future<bool> acceptQRInvitation(...) async {
  try {
    // å‡¦ç†
    return true;
  } catch (e) {
    return false;
  }
}

// After
Future<Result<void>> acceptQRInvitation(...) async {
  try {
    // å‡¦ç†
    return const Result.success(null);
  } catch (e, stackTrace) {
    return Result.failure(e.toString(), stackTrace);
  }
}

// å‘¼ã³å‡ºã—å´
final result = await service.acceptQRInvitation(...);
result.when(
  success: (_) => print('æˆåŠŸ'),
  failure: (error, _) => print('å¤±æ•—: $error'),
);
```

---

## ç¬¬ 4 ã‚¹ãƒ†ãƒƒãƒ—: ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

### Task 4.1: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ†ã‚¹ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `test/services/invitation_security_service_test.dart`

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:goshopping/services/invitation_security_service.dart';

void main() {
  late InvitationSecurityService service;

  setUp(() {
    service = InvitationSecurityService();
  });

  group('InvitationSecurityService', () {
    test('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã¯32æ–‡å­—', () {
      final key = service.generateSecurityKey();
      expect(key.length, equals(32));
    });

    test('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã¯è‹±æ•°å­—ã®ã¿', () {
      final key = service.generateSecurityKey();
      expect(key, matches(RegExp(r'^[a-zA-Z0-9]+$')));
    });

    test('æ‹›å¾…IDã«ã¯ã‚°ãƒ«ãƒ¼ãƒ—IDãŒå«ã¾ã‚Œã‚‹', () {
      final groupId = 'test-group-123';
      final invitationId = service.generateInvitationId(groupId);
      expect(invitationId, startsWith(groupId));
    });

    test('åŒã˜å…¥åŠ›ã§ç•°ãªã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã‚‹', () {
      final key1 = service.generateSecurityKey();
      final key2 = service.generateSecurityKey();
      expect(key1, isNot(equals(key2)));
    });

    test('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã®æ¤œè¨¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', () {
      final key = service.generateSecurityKey();
      expect(service.validateSecurityKey(key, key), isTrue);
      expect(service.validateSecurityKey(key, 'wrong-key'), isFalse);
    });
  });
}
```

### Task 4.2: QR æ‹›å¾…ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ†ã‚¹ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `test/services/qr_invitation_service_test.dart`

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:goshopping/services/qr_invitation_service.dart';

void main() {
  group('QRInvitationService', () {
    test('QRãƒ‡ãƒ¼ã‚¿ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ‡ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', () {
      final service = QRInvitationService(mockRef);
      final originalData = {
        'invitationId': 'test-123',
        'groupName': 'ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—',
        'invitationType': 'individual',
      };

      final encoded = service.encodeQRData(originalData);
      final decoded = service.decodeQRData(encoded);

      expect(decoded, isNotNull);
      expect(decoded!['invitationId'], equals('test-123'));
      expect(decoded['groupName'], equals('ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—'));
    });

    test('ç„¡åŠ¹ãªQRãƒ‡ãƒ¼ã‚¿ã¯nullã‚’è¿”ã™', () {
      final service = QRInvitationService(mockRef);
      final decoded = service.decodeQRData('invalid-data');
      expect(decoded, isNull);
    });
  });
}
```

### Task 4.3: çµ±åˆãƒ†ã‚¹ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `integration_test/invitation_flow_test.dart`

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:goshopping/main.dart' as app;

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  group('æ‹›å¾…ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ', () {
    testWidgets('QRæ‹›å¾…ã®ä½œæˆã‹ã‚‰å—è«¾ã¾ã§', (tester) async {
      app.main();
      await tester.pumpAndSettle();

      // 1. ãƒ­ã‚°ã‚¤ãƒ³
      // ...

      // 2. ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
      // ...

      // 3. QRæ‹›å¾…ä½œæˆ
      await tester.tap(find.text('QRæ‹›å¾…'));
      await tester.pumpAndSettle();
      expect(find.byType(QrImageView), findsOneWidget);

      // 4. QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºç¢ºèª
      expect(find.text('å€‹åˆ¥æ‹›å¾…'), findsOneWidget);
      expect(find.text('ãƒ•ãƒ¬ãƒ³ãƒ‰æ‹›å¾…'), findsOneWidget);

      // 5. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
      await tester.tap(find.text('é–‰ã˜ã‚‹'));
      await tester.pumpAndSettle();
    });
  });
}
```

### Task 4.4: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ + ã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆ
flutter test --coverage

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºï¼ˆHTMLï¼‰
genhtml coverage/lcov.info -o coverage/html
open coverage/html/index.html
```

**ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸:**

```
services/: 70%
models/: 80%
utils/: 60%
widgets/: 50%
å…¨ä½“: 60%
```

---

## ç¬¬ 5 ã‚¹ãƒ†ãƒƒãƒ—: æœ€é©åŒ–ã¨ä»•ä¸Šã’

### Task 5.1: Firestore ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `firestore.indexes.json`

```json
{
  "indexes": [
    {
      "collectionGroup": "notifications",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "read", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "invitations",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "expiresAt", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "SharedGroups",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "allowedUid", "order": "ASCENDING" },
        { "fieldPath": "lastUpdated", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

**ãƒ‡ãƒ—ãƒ­ã‚¤:**

```bash
firebase deploy --only firestore:indexes
```

### Task 5.2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/services/cache_service.dart`

```dart
import 'dart:collection';
import '../models/shared_group.dart';

/// ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒ“ã‚¹
class CacheService {
  static const int maxCacheSize = 50;
  final _cache = LinkedHashMap<String, CacheEntry<dynamic>>();

  /// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
  T? get<T>(String key) {
    final entry = _cache[key];
    if (entry == null) return null;

    if (entry.isExpired) {
      _cache.remove(key);
      return null;
    }

    return entry.value as T;
  }

  /// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  void set<T>(String key, T value, {Duration ttl = const Duration(minutes: 5)}) {
    if (_cache.length >= maxCacheSize) {
      // LRU: æœ€ã‚‚å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
      _cache.remove(_cache.keys.first);
    }

    _cache[key] = CacheEntry<T>(
      value: value,
      expiresAt: DateTime.now().add(ttl),
    );
  }

  /// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  void clear() => _cache.clear();

  /// ç‰¹å®šã®ã‚­ãƒ¼ã‚’å‰Šé™¤
  void remove(String key) => _cache.remove(key);
}

class CacheEntry<T> {
  final T value;
  final DateTime expiresAt;

  CacheEntry({required this.value, required this.expiresAt});

  bool get isExpired => DateTime.now().isAfter(expiresAt);
}
```

### Task 5.3: ãƒ­ã‚°ç®¡ç†ã®çµ±ä¸€

**æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/utils/app_logger.dart`

```dart
enum LogLevel {
  debug,
  info,
  warning,
  error,
}

class AppLogger {
  static LogLevel _minLevel = LogLevel.info;

  static void configure({required LogLevel minLevel}) {
    _minLevel = minLevel;
  }

  static void debug(String message) {
    _log(LogLevel.debug, message);
  }

  static void info(String message) {
    _log(LogLevel.info, message);
  }

  static void warning(String message) {
    _log(LogLevel.warning, message);
  }

  static void error(String message) {
    _log(LogLevel.error, message);
  }

  static void _log(LogLevel level, String message) {
    if (level.index < _minLevel.index) return;

    final prefix = _getPrefix(level);
    final timestamp = DateTime.now().toIso8601String();
    print('[$timestamp] $prefix $message');
  }

  static String _getPrefix(LogLevel level) {
    switch (level) {
      case LogLevel.debug:
        return 'ğŸ”';
      case LogLevel.info:
        return 'â„¹ï¸';
      case LogLevel.warning:
        return 'âš ï¸';
      case LogLevel.error:
        return 'âŒ';
    }
  }
}
```

**main.dart ã§ã®è¨­å®š:**

```dart
void main() async {
  // é–‹ç™ºç’°å¢ƒ: ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
  // æœ¬ç•ªç’°å¢ƒ: ã‚¨ãƒ©ãƒ¼ã®ã¿
  AppLogger.configure(
    minLevel: F.appFlavor == Flavor.prod
      ? LogLevel.error
      : LogLevel.debug,
  );

  runApp(MyApp());
}
```

### Task 5.4: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

**æ›´æ–°å¯¾è±¡:**

1. `docs/sync_architecture.md` - SyncService ã®è¿½åŠ 
2. `docs/invitation_system.md` - å‹å®‰å…¨æ€§ã®æ”¹å–„
3. `docs/notification_system.md` - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€
4. `README.md` - ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ–¹æ³•è¿½åŠ 

---

## ğŸ“Š æˆæœç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚³ãƒ¼ãƒ‰

- [ ] SyncService å®Ÿè£…
- [ ] ErrorHandler å®Ÿè£…
- [ ] RepositoryFactory å®Ÿè£…
- [ ] NotificationMetadata å‹å®šç¾©
- [ ] InvitationData å‹å®šç¾©
- [ ] Result å‹ å®Ÿè£…
- [ ] CacheService å®Ÿè£…

### ãƒ†ã‚¹ãƒˆ

- [ ] InvitationSecurityService ãƒ†ã‚¹ãƒˆ
- [ ] QRInvitationService ãƒ†ã‚¹ãƒˆ
- [ ] NotificationService ãƒ†ã‚¹ãƒˆ
- [ ] SyncService ãƒ†ã‚¹ãƒˆ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆæ‹›å¾…ãƒ•ãƒ­ãƒ¼ï¼‰
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ 60%é”æˆ

### æœ€é©åŒ–

- [ ] Firestore ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
- [ ] ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
- [ ] ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ç®¡ç†
- [ ] ä¸è¦ãªã‚³ãƒ¼ãƒ‰å‰Šé™¤

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å†…å®¹ã®è¨˜éŒ²
- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ‰‹é †ã®è¿½åŠ 
- [ ] æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å›³è§£
- [ ] FAQ æ›´æ–°

---

## ğŸ‰ æœŸå¾…ã•ã‚Œã‚‹æˆæœ

### å®šé‡çš„

- ã‚³ãƒ¼ãƒ‰è¡Œæ•°: 5,000 â†’ 4,000ï¼ˆ-20%ï¼‰
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 0% â†’ 60%
- ãƒ“ãƒ«ãƒ‰æ™‚é–“: å¤‰åŒ–ãªã—
- èµ·å‹•æ™‚é–“: 2 ç§’ â†’ 1.5 ç§’

### å®šæ€§çš„

- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š
- ä¿å®ˆæ€§ã®å‘ä¸Š
- ãƒã‚°æ¤œå‡ºã®å®¹æ˜“åŒ–
- æ–°æ©Ÿèƒ½è¿½åŠ ã®åŠ¹ç‡åŒ–

---

**ä½œæˆæ—¥:** 2025 å¹´ 11 æœˆ 8 æ—¥
**å¯¾è±¡æœŸé–“:** 2025 å¹´ 11 æœˆ 11 æ—¥ã€œ15 æ—¥
**æ‹…å½“:** é–‹ç™ºãƒãƒ¼ãƒ 
**ãƒ¬ãƒ“ãƒ¥ãƒ¼:** é‡‘æ›œæ—¥åˆå¾Œ
