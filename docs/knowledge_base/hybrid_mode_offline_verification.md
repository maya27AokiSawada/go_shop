# Hybrid Mode Offline Verification (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œæ¤œè¨¼)

**Date**: 2026-01-08
**Verified By**: Production deployment scenario
**Test Environment**: SH 54D (Android 15), Flavor.prod

## æ¦‚è¦

Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œã«ç™ºç”Ÿã—ãŸã€Œç–‘ä¼¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã€ã«ã‚ˆã‚Šã€HybridRepositoryã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œã¨Firestoreå¾©å¸°æ™‚ã®è‡ªå‹•åŒæœŸãŒå¶ç„¶ã«ã‚‚å®Ÿè¨¼ã•ã‚Œã¾ã—ãŸã€‚

## æ¤œè¨¼ã‚·ãƒŠãƒªã‚ª

### åˆæœŸçŠ¶æ…‹

- **Firebase Project**: goshopping-48db9 (prod)
- **ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ**: `firebase deploy --only firestore:rules,firestore:indexes`
- **ã‚¢ãƒ—ãƒªèµ·å‹•**: ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œï¼ˆãƒ«ãƒ¼ãƒ«ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åæ˜ å‰ï¼‰

### ç–‘ä¼¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç™ºç”Ÿ

Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã¯**ä¼æ’­æ™‚é–“**ãŒå¿…è¦ï¼š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«: é€šå¸¸1-5åˆ†
- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: æœ€å¤§æ•°ååˆ†ï¼ˆãƒ‡ãƒ¼ã‚¿é‡ã«ã‚ˆã‚‹ï¼‰

ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œã«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ãŸãŸã‚ã€ä»¥ä¸‹ã®çŠ¶æ…‹ãŒç™ºç”Ÿï¼š
- Firestoreæ›¸ãè¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹
- HybridRepositoryãŒè‡ªå‹•çš„ã«Hiveã‚ªãƒ³ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

## æ¤œè¨¼çµæœ

### 1. Hiveã‚ªãƒ³ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®æ­£å¸¸å‹•ä½œ âœ…

**å‹•ä½œå†…å®¹**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ: ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆï¼ˆ"1350", "1355", "1356"ï¼‰
    â†“
HybridRepository: Firestoreæ›¸ãè¾¼ã¿å¤±æ•—ã‚’æ¤œå‡º
    â†“
è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Hiveã«ä¿å­˜ (syncStatus = SyncStatus.local)
    â†“
UIè¡¨ç¤º: æ­£å¸¸ã«è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ã«æ°—ã¥ã‹ãªã„ï¼‰
```

**æŠ€è¡“è©³ç´°**:
```dart
// lib/datastore/hybrid_purchase_group_repository.dart
if (F.appFlavor == Flavor.prod && _firestoreRepo != null) {
  try {
    await _firestoreRepo!.createGroup(groupId, groupName, member);
  } catch (e) {
    // Firestoreã‚¨ãƒ©ãƒ¼ â†’ Hiveãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    developer.log('âŒ Firestoreæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: $e');
    final newGroup = await _hiveRepo.createGroup(groupId, groupName, member);
    return newGroup.copyWith(syncStatus: SyncStatus.local); // â† é‡è¦
  }
}
```

**ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**:
- ã‚°ãƒ«ãƒ¼ãƒ—ID: 1767847832510 (1350)
- ã‚°ãƒ«ãƒ¼ãƒ—ID: 1767848117297 (1355)
- ã‚°ãƒ«ãƒ¼ãƒ—ID: 1767848279301 (1356)
- ã™ã¹ã¦`syncStatus: SyncStatus.local`ã§ãƒãƒ¼ã‚­ãƒ³ã‚°

### 2. Firestoreå¾©å¸°æ™‚ã®è‡ªå‹•åŒæœŸ âœ…

**ã‚¢ãƒ—ãƒªå†èµ·å‹•ãƒ­ã‚°**ï¼ˆFirestoreæ­£å¸¸åŒ–å¾Œï¼‰:
```
ğŸ“¤ [SYNC] localçŠ¶æ…‹ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’Firestoreã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: 1350
âœ… [SYNC] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: 1350
ğŸ“¤ [SYNC] localçŠ¶æ…‹ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’Firestoreã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: 1355
âœ… [SYNC] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: 1355
ğŸ“¤ [SYNC] localçŠ¶æ…‹ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’Firestoreã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: 1356
âœ… [SYNC] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: 1356
ğŸ“¤ [SYNC] 3å€‹ã®localã‚°ãƒ«ãƒ¼ãƒ—ã‚’Firestoreã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ
```

**åŒæœŸãƒ—ãƒ­ã‚»ã‚¹**:
```
1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚: UserInitializationServiceå®Ÿè¡Œ
2. Hiveå†…ã‚’æ¤œç´¢: syncStatus == SyncStatus.local ã®ã‚°ãƒ«ãƒ¼ãƒ—æ¤œå‡º
3. Firestoreã«é †æ¬¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
4. syncStatusæ›´æ–°: SyncStatus.local â†’ SyncStatus.synced
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸è¦ã§å®Œäº†
```

**ã‚³ãƒ¼ãƒ‰å®Ÿè£…**:
```dart
// lib/services/sync_service.dart
// Hiveã‹ã‚‰æœªåŒæœŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
final localGroups = hiveGroups.where((g) =>
  g.syncStatus == SyncStatus.local && !g.isDeleted
).toList();

// Firestoreã«é †æ¬¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
for (final group in localGroups) {
  try {
    await _firestore.collection('SharedGroups').doc(group.groupId).set({
      ...group.toFirestore(),
      'syncStatus': 'synced',
    });
    developer.log('âœ… [SYNC] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${group.groupName}');
  } catch (e) {
    developer.log('âŒ [SYNC] ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${group.groupName} - $e');
  }
}
```

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ¤œè¨¼ âœ…

**é‡è¦ãªç™ºè¦‹**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Firestoreéšœå®³ã«å…¨ãæ°—ã¥ã‹ãªã„
- ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ»ç·¨é›†ãŒé€šå¸¸é€šã‚Šå‹•ä½œ
- å†èµ·å‹•å¾Œã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿åŒæœŸ
- **ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ã‚¼ãƒ­**

## å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

ã“ã®æ¤œè¨¼ã¯ä»¥ä¸‹ã®å®Ÿéš›ã®ã‚·ãƒŠãƒªã‚ªã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ï¼š

### ã‚±ãƒ¼ã‚¹1: é›»è»Šå†…ã§ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åˆ©ç”¨

```
çŠ¶æ³: åœ°ä¸‹é‰„ã§åœå¤–ï¼ˆFirestoreæ¥ç¶šä¸å¯ï¼‰
    â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ: è²·ã„ç‰©ãƒªã‚¹ãƒˆä½œæˆãƒ»ç·¨é›†
    â†“
ä¿å­˜å…ˆ: Hive (syncStatus.local)
    â†“
åœ°ä¸Šã«å‡ºã¦åœå†…å¾©å¸°
    â†“
è‡ªå‹•åŒæœŸ: Firestore â† ä»Šå›æ¤œè¨¼ï¼
```

### ã‚±ãƒ¼ã‚¹2: Firebaseéšœå®³æ™‚ã®ç¶™ç¶šå‹•ä½œ

```
çŠ¶æ³: Firebaseãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚„éšœå®³
    â†“
ã‚¢ãƒ—ãƒªå‹•ä½œ: æ­£å¸¸å‹•ä½œç¶™ç¶šï¼ˆHiveãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    â†“
Firebaseå¾©æ—§: è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿åŒæœŸ
    â†“
çµæœ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯éšœå®³ã«æ°—ã¥ã‹ãªã„
```

### ã‚±ãƒ¼ã‚¹3: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®šç’°å¢ƒ

```
çŠ¶æ³: å¼±ã„é›»æ³¢ãƒ»æ–­ç¶šçš„æ¥ç¶š
    â†“
Firestoreæ›¸ãè¾¼ã¿: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¤šç™º
    â†“
HybridRepository: è‡ªå‹•çš„ã«Hiveã«ä¿å­˜
    â†“
å®‰å®šåŒ–å¾Œ: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åŒæœŸ
```

## æŠ€è¡“çš„ãªé‡è¦ãƒã‚¤ãƒ³ãƒˆ

### syncStatusã®æ´»ç”¨

```dart
enum SyncStatus {
  local,    // Hiveã®ã¿ã«ä¿å­˜ï¼ˆæœªåŒæœŸï¼‰
  synced,   // Firestoreã¨åŒæœŸæ¸ˆã¿
  conflict  // ç«¶åˆç™ºç”Ÿï¼ˆæ‰‹å‹•è§£æ±ºå¿…è¦ï¼‰
}
```

**åŒæœŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯**:
```dart
// æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡º
final needsSync = allGroups.where((g) =>
  g.syncStatus == SyncStatus.local && !g.isDeleted
);

// åŒæœŸæ¸ˆã¿ã®ç¢ºèª
final isSynced = group.syncStatus == SyncStatus.synced;
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³

**ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**
```dart
try {
  await _firestoreRepo.createGroup(...);
} catch (e) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã›ãšã€Hiveã«ä¿å­˜
  return await _hiveRepo.createGroup(...);
}
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹**
```dart
// sync_service.dartå†…
int retryCount = 0;
const maxRetries = 3;

while (retryCount < maxRetries) {
  try {
    await uploadToFirestore(group);
    break;
  } catch (e) {
    retryCount++;
    await Future.delayed(Duration(seconds: retryCount * 2));
  }
}
```

### åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°

1. **ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚** (æœ€å„ªå…ˆ)
   - `UserInitializationService.initialize()`
   - æœªåŒæœŸãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ¤œå‡ºãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

2. **å®šæœŸãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰** (5åˆ†é–“éš”)
   - `PeriodicSyncService`
   - localçŠ¶æ…‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œ** (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
   - ã€ŒåŒæœŸã€ãƒœã‚¿ãƒ³æ‰‹å‹•å®Ÿè¡Œ
   - è¨­å®šç”»é¢ã‹ã‚‰ã®å¼·åˆ¶åŒæœŸ

## æ•™è¨“

### 1. Firebaseãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å¾…æ©Ÿæ™‚é–“

**æ¨å¥¨**:
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ: **5-10åˆ†å¾…æ©Ÿ**
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ: **æœ€å¤§30åˆ†å¾…æ©Ÿ**ï¼ˆè¤‡é›‘ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å ´åˆï¼‰

**ç†ç”±**:
- Firebaseã¯åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®ãŸã‚ã€å…¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ä¼æ’­ã«æ™‚é–“ãŒå¿…è¦
- ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œã¯writeæ“ä½œãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

### 2. HybridArchitectureã®æœ‰åŠ¹æ€§

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã‚‚å®Œå…¨å‹•ä½œ
- âœ… Firestoreéšœå®³æ™‚ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹é˜²æ­¢
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Šï¼ˆã‚¨ãƒ©ãƒ¼ã‚’æ„è­˜ã•ã›ãªã„ï¼‰

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**:
- âš ï¸ åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã®è¤‡é›‘æ€§
- âš ï¸ syncStatusã®ç®¡ç†å¿…è¦
- âš ï¸ ç«¶åˆè§£æ±ºã®å®Ÿè£…å¿…è¦ï¼ˆå°†æ¥ï¼‰

### 3. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®æ”¹å–„

**ä»Šå¾Œã®æ¤œè¨¼é …ç›®**:
- [ ] æ„å›³çš„ãªFirestoreåˆ‡æ–­ãƒ†ã‚¹ãƒˆï¼ˆæ©Ÿå†…ãƒ¢ãƒ¼ãƒ‰ï¼‰
- [ ] å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã®ç«¶åˆç™ºç”Ÿã‚·ãƒŠãƒªã‚ª
- [ ] ãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ã®æœ€é©åŒ–ï¼ˆåŒæœŸé »åº¦èª¿æ•´ï¼‰

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `lib/datastore/hybrid_purchase_group_repository.dart` - Hybrid Repositoryå®Ÿè£…
- `lib/datastore/hybrid_shared_list_repository.dart` - Listç”¨Hybrid Repository
- `lib/services/sync_service.dart` - åŒæœŸã‚µãƒ¼ãƒ“ã‚¹
- `lib/services/user_initialization_service.dart` - èµ·å‹•æ™‚åŒæœŸ
- `lib/models/shared_group.dart` - syncStatusãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
- `firestore.rules` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤é…å»¶ã®åŸå› ï¼‰

## ã¾ã¨ã‚

**ä»Šå›ã®ã€Œäº‹æ•…ã€ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿè¨¼ã•ã‚Œã¾ã—ãŸ**:

âœ… HybridRepositoryã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œå®Œå…¨æ€§
âœ… è‡ªå‹•åŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®æ­£å¸¸å‹•ä½œ
âœ… ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ã‚¼ãƒ­ã®å®Ÿç¾
âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¸ã®å½±éŸ¿ã‚¼ãƒ­

**çµè«–**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãŒå®Ÿéš›ã®éšœå®³ã‚·ãƒŠãƒªã‚ªã§æœŸå¾…é€šã‚Šã«å‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚

---

**å‚è€ƒ**: Firebaseãƒ‡ãƒ—ãƒ­ã‚¤ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«: `firebase deploy --only firestore:rules`
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: `firebase deploy --only firestore:indexes`
- ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å¾…æ©Ÿ: 5-10åˆ†ï¼ˆæ¨å¥¨ï¼‰
- ç¢ºèªæ–¹æ³•: Firebase Console â†’ Firestore â†’ Rules/Indexes ã‚¿ãƒ–ã§ "Active" è¡¨ç¤ºã‚’ç¢ºèª
